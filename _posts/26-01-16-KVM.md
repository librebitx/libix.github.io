---
layout: default
title:   "KVM"
date:   2026-01-15
blog-label: Notes
---

# 什么是 KVM？
**KVM (Kernel-based Virtual Machine)**，字面意思就是“基于内核的虚拟机”。
它不是安装在 Linux 上的一个软件，它就是 Linux 内核的一部分。
相比于其他虚拟化软件，在 Linux 中创建 Linux 虚拟机 KVM 拥有极致的性能，虚拟机直接调用 CPU 的虚拟化指令，性能几乎等同于物理机。只要 Linux 内核升级变强了，KVM 立刻、自动、免费地跟着变强。它不需要像其他虚拟化软件那样单独开发一套内核。
阿里云、腾讯云、AWS、Google Cloud、OpenStack…… 它们底层跑的 90% 都是 KVM。

# 安装 KVM


```bash
sudo apt update
sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager virtinst libguestfs-tools
sudo systemctl enable --now libvirtd
# 启动默认网络
sudo virsh net-start default
# 设置开机自启（防止下次重启又报错）
sudo virsh net-autostart default
```

# 命令行

```bash
sudo virsh list --all		# 查看所有虚拟机
sudo virsh start demo-vm		# 启动虚拟机
sudo virsh shutdown demo-vm		# 优雅关机 (相当于按电源键，通知系统关机)
sudo virsh destroy demo-vm		# 强制拔电源 (虚拟机卡死时用)
sudo virsh autostart demo-vm		# 设置开机自启
sudo virsh undefine demo-vm		# 彻底删除虚拟机 (删除配置，但保留磁盘文件)
sudo virsh console kmaster			# 连接到虚拟机

```

# KVM 网络

## NAT (virbr0)
默认模式，KVM 在你的宿主机里虚拟了一个“路由器”（通常叫 `virbr0`），你的虚拟机插在这个路由器上。
    虚拟机可以上网（通过宿主机转发）。
    宿主机可以通过 IP 连接虚拟机。
    局域网里的其他电脑（比如你的手机、同事的电脑）访问不到这台虚拟机。

```bash
# 配置
--network network=default
# 查看名为 devops-node 的虚拟机 IP
virsh domifaddr devops-node 
```


## 桥接 (Bridge)
使虚拟机像一台真实的物理机一样，拥有和宿主机同一网段的 IP，让局域网里的所有设备都能直接访问它。
**标准的 Linux 网桥不支持无线网卡 (WiFi)。这是无线协议（802.11）的限制。**

```bash
# 创建网桥 (br0)
# 创建一个名为 br0 的虚拟交换机。
sudo nmcli con add type bridge ifname br0 con-name br0

# 把物理网卡绑定给网桥，替换 enp3s0 为真实网卡名
sudo nmcli con add type ethernet slave-type bridge con-name bridge-slave-enp3s0 ifname enp3s0 master br0

# 关闭 STP (生成树协议)
# 做实验不需要这个防环路协议，关掉可以加快启动速度，防止连不上网。
sudo nmcli con modify br0 bridge.stp no

# 启用网桥
# 这步操作后，你的网络会重连。物理网卡自己不再持有 IP，IP 会转移到 br0 上。
# 关闭当前的物理连接
sudo nmcli con down enp3s0
# (注：名字可能是 "System enp3s0" 或其他，用 nmcli con show 查看)

# 启动网桥
sudo nmcli con up br0

### 物理网卡变成了一个“傻瓜交换机端口”，网桥 br0 变成了系统里唯一能上网的“虚拟网卡”。
### br0 的 MAC 地址通常会“继承”（复制）物理网卡的 MAC 地址。

# 把物理网卡变成网桥的一个“端口” (Slave)
sudo nmcli con add type ethernet slave-type bridge con-name bridge-slave-enx ifname enp3s0 master br0
# 激活这个连接 (这一步会断网重连)
sudo nmcli con up bridge-slave-enx

# 修改 ip 
sudo nmcli con modify br0 ipv4.addresses 192.168.0.5/24
sudo nmcli con modify br0 ipv4.gateway 192.168.0.1
sudo nmcli con modify br0 ipv4.dns "192.168.1.1 192.168.0.1"
sudo nmcli con modify br0 ipv4.method manual
sudo nmcli con down br0 && sudo nmcli con up br0
```

```bash
# 配置: 在 virt-install 时添加
--network bridge=br0
```

# Cockpit Web

Web 界面管理服务器。Debian 自带，叫 **Cockpit**。

```bash
sudo apt install cockpit cockpit-machines -y			# 安装 Cockpit 和 KVM 插件
sudo systemctl enable --now cockpit.socket
```

**使用**：
打开浏览器（Chrome/Firefox），访问：`http://localhost:9090`
输入你的 Debian 用户名和密码。
点击左侧的 **"Virtual Machines"**。

# 快照 / 克隆

```bash
### 快照
# 创建快照
# 语法：virsh snapshot-create-as 虚拟机名 快照名 "描述"
sudo virsh snapshot-create-as devops-node fresh-install "clean"

# 查看快照
sudo virsh snapshot-list devops-node

# 还原快照
sudo virsh snapshot-revert devops-node fresh-install

# 删除快照
sudo virsh snapshot-delete devops-node fresh-install

### 克隆
# 完整克隆
sudo virt-clone --original devops-node --name devops-worker-01 --auto-clone
# --original: 源虚拟机名字
# --name: 新虚拟机名字
# --auto-clone: 自动处理磁盘路径和 MAC 地址

# 链接克隆
sudo qemu-img create -f qcow2 -F qcow2 -b debian12-cloud.qcow2 worker-02.qcow2
# -b: 指定母盘
# -f: 指定格式
# -F: 指定母盘格式
sudo virt-install --name devops-worker-02 --memory 2048 --vcpus 2 --disk /var/lib/libvirt/images/worker-02.qcow2 --import --os-variant debian12 --graphics none
# 对于“虚拟机内部的操作系统”来说，完整克隆和链接克隆完全没有区别
```



# 总结
虚拟机启动后，虚拟机系统中的配置默认存放在 **/var/lib/libvirt/images/** 的 .qcow2 中；
虚拟机的硬件信息存放在 **	** 的 .xml 文件中 
**.qcow2** 全称是 **QEMU Copy On Write (写时复制)**。它有两个特性：
**动态分配**：给虚拟机分了 10GB 硬盘，实际上刚创建时，`.qcow2` 文件可能只有 **2MB**（仅包含元数据）。它**用多少、占多少**，直到达到 10GB 上限。这为你节省了大量硬盘空间。
**支持快照/克隆**；
不要手动重命名或移动 QCOW2 文件！
正确的改名姿势： 需要先关机，改文件名，然后用 `virsh edit 虚拟机名` 修改 XML 里的 `<source file='...'/>` 路径，保存后才能开机。

> Ubuntu 有个坑：它的文件后缀通常是 `.img`，但其实它就是 qcow2 格式！建议手动把后缀改成 `.qcow2`，以免自己弄混。
>
> https://cloud-images.ubuntu.com/
>
> https://cloud.debian.org/images/cloud/
>
> https://cloud.centos.org/centos/
>
> https://www.rockylinux.cn/download

# 测试

/var/lib/libvirt/images/ 是默认目录，把镜像放在自定义目录

```bash
# 修改所有者为 libvirt-qemu:libvirt-qemu
sudo chown libvirt-qemu:libvirt-qemu /media/libix/Storage/K8s/noble-server-cloudimg-amd64.qcow2

# 还要确保 KVM 能“路过”前面的目录也就是 /home 和 /home/libix 必须允许“其他人”有执行(x)权限
sudo chmod o+x /media/libix
sudo chmod o+x /media/libix/Storage
sudo chmod o+x /media/libix/Storage/K8s

libix@Debian:~$ ssh-keygen -t rsa -b 2048
# 一路按回车（3次），不要设密码

sudo qemu-img resize /media/libix/Storage/K8s/noble-server-cloudimg-amd64.qcow2 20G

sudo virt-customize -a /media/libix/Storage/K8s/noble-server-cloudimg-amd64.qcow2 \
  --root-password password:123456 \
  --ssh-inject root:file:/home/libix/.ssh/id_rsa.pub
# -o /var/lib/libvirt/images/devops-node.qcow2		输出磁盘文件
# --root-password password:123456
# --ssh-inject root:file:~/.ssh/id_rsa.pub

sudo virt-install \
  --name kmaster \
  --memory 2048 \
  --vcpus 2 \
  --disk /media/libix/Storage/K8s/noble-server-cloudimg-amd64.qcow2 \
  --import \
  --network bridge=br0 \
  --os-variant ubuntu24.04 \
  --graphics none \
  --noautoconsole

# virt-install		使用 libvirt 创建虚拟机
# --disk /var/lib/libvirt/images/devops-node.qcow2		使用已生成的磁盘
# --import		告诉 libvirt，系统已经装好，直接启动
# --os-variant debian12 	指定系统
# --graphics none		不配置图形显卡，也不启动 VNC/SPICE 远程桌面服务
# --console pty,target_type=serial	给虚拟机接一根虚拟的串口线，并把它连接到你当前的终端窗口上（ "ctrl+]" 退出 ）


```



```bash
# Ubuntu 配置静态 IP
sudo rm -rf /etc/netplan/50-cloud-init.yaml
ls -l /etc/netplan/

sudo cat <<EOF> /etc/netplan/01-static.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    enp1s0:			# 注意修改
      dhcp4: false
      addresses:
        - 192.168.0.10/24
      routes:
        - to: default
          via: 192.168.0.1
      nameservers:
        addresses:
          - 192.168.1.1
          - 192.168.0.1
EOF
ls -l /etc/netplan/
sudo netplan try
sudo netplan apply

sudo tee /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg <<EOF
network: {config: disabled}
EOF

reboot
```

