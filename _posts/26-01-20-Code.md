---
layout: default
title:   "Code"
date:   2026-01-19
blog-label: Notes
---

# Terraform

## main.tf

/terraform/main.tf

```bash
### å˜é‡å®šä¹‰  -----------------------------------------------------------------
variable "cluster_nodes" {
  type = map(object({
    hostname     = string
    ip_last_byte = string
  }))
  default = {
    # æƒ³è¦æ·»åŠ å®ä¾‹ï¼Œåªéœ€åœ¨è¿™é‡Œæ·»åŠ ä¸€è¡Œå³å¯
    "0" = { hostname = "kmaster", ip_last_byte = "10" }
    "1" = { hostname = "knode1", ip_last_byte = "11" }
    "2" = { hostname = "knode2", ip_last_byte = "12" }
  }
}

variable "network_prefix" { default = "192.168.0" }
variable "gateway" { default = "192.168.0.1" }
variable "dns_servers" { default = ["192.168.1.1", "192.168.0.1"] }

### Terraform æ’ä»¶é…ç½® -----------------------------------------------------------------
terraform {
  required_providers {
    libvirt = {
      # æŒ‡å®šä½¿ç”¨ç¬¬ä¸‰æ–¹ç»´æŠ¤çš„ Libvirt æ’ä»¶ï¼ˆç”¨äºç®¡ç† KVMï¼‰
      source  = "dmacvicar/libvirt"
      version = "0.7.6" # æŒ‡å®šç‰ˆæœ¬
    }
  }
}

## è¿æ¥æœ¬åœ° Libvirt ç³»ç»ŸæœåŠ¡
provider "libvirt" {
  uri = "qemu:///system" # è¡¨ç¤ºä»¥ç³»ç»Ÿçº§æƒé™è¿æ¥ï¼Œå¯ä»¥ç®¡ç†æ¡¥æ¥ç½‘ç»œç­‰é«˜çº§èµ„æº
}

# ## è‡ªå®šä¹‰é•œåƒå­˜å‚¨æ± 
# å®éªŒç¯å¢ƒå¯ä»¥è‡ªå®šä¹‰å­˜å‚¨æ± ï¼Œä¿®æ”¹ /etc/libvirt/qemu.conf æ–‡ä»¶ï¼Œæ·»åŠ  user = "root" ï¼Œ group = "root" ï¼Œsecurity_driver = "none" ç„¶åé‡å¯ libvirtd æœåŠ¡
# å·¥ä½œç¯å¢ƒä¸è¦ä¿®æ”¹  KVM é»˜è®¤å­˜å‚¨æ± ï¼Œé¿å…å½±å“å…¶ä»–è™šæ‹Ÿæœº
# resource "libvirt_pool" "image-pool" {
#   name = "image-pool" 	# ç»™æ± å­èµ·ä¸ªé€»è¾‘åå­—
#   type = "dir"
#   path = "/home/libix/Desktop/terraform" 		# å®é™…ç‰©ç†è·¯å¾„
# }

### ç¡¬ç›˜é…ç½®ï¼šå®šä¹‰è™šæ‹Ÿæœºçš„ç³»ç»Ÿç›˜  -----------------------------------------------------------------
resource "libvirt_volume" "Disk" {
  for_each = var.cluster_nodes
  name     = "${each.value.hostname}.qcow2" # åœ¨ for_each å¾ªç¯ä¸­ï¼Œæ ¹æ®æ¯ä¸ªèŠ‚ç‚¹çš„ hostname åŠ¨æ€ç”Ÿæˆå”¯ä¸€çš„ç£ç›˜åç§°
  pool     = "default"                      # ä½¿ç”¨ KVM é»˜è®¤å­˜å‚¨æ±  /var/lib/libvirt/images/
  # pool = libvirt_pool.image-pool.name  # ä½¿ç”¨å®šä¹‰çš„è‡ªå®šä¹‰å­˜å‚¨æ± ,è¿™é‡Œçš„ name æŒ‡çš„æ˜¯ä¸Šé¢ image-pool èµ„æºçš„ name å±æ€§å€¼ï¼Œå³ "image-pool"
  # Terraform ä¼šè‡ªåŠ¨æŠŠè¿™ä¸ªæ–‡ä»¶å¤åˆ¶ä¸€ä»½ä½œä¸ºæ–°è™šæ‹Ÿæœºçš„ç¡¬ç›˜ï¼Œä¸ä¼šç ´ååŸæ–‡ä»¶
  source = "/var/lib/libvirt/images/ubuntu-template.qcow2" # é•œåƒæ¥æº
  format = "qcow2"
}

# ### å®šä¹‰ Cloud-Init ISO -----------------------------------------------------------------
# # Terraform ä¼šæ ¹æ®è¿™äº›å†…å®¹ç”Ÿæˆä¸€ä¸ª .iso é•œåƒï¼ŒæŒ‚è½½ç»™è™šæ‹Ÿæœºè¯»å–
resource "libvirt_cloudinit_disk" "commoninit" {
  for_each = var.cluster_nodes
  name     = "init-${each.value.hostname}.iso"
  pool     = "default"
  # pool = libvirt_pool.image-pool.name  # ä½¿ç”¨å®šä¹‰çš„è‡ªå®šä¹‰å­˜å‚¨æ± 

  user_data = <<EOF
#cloud-config
hostname: ${each.value.hostname}
manage_etc_hosts: true
timezone: Asia/Shanghai

users:
  - name: libix
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    passwd: "$6$nuR8GV0zikMlNqOc$agrrbn//ZTLLW.6lI2w.I/Qn5EFKuZE5eujKFArblY/REERhwbc2ht5BOoIwRXlzM5tBP0.cPmZ64WVkoOd9I/"
    ssh_authorized_keys:
      - ${file("/home/libix/.ssh/id_ed25519.pub")}
 
package_update: true
packages:
  - qemu-guest-agent
  - net-tools
  - curl
  - vim
  - wget
  - tree
  - lsof
  - tcpdump
  - sysstat
  - unzip
  - iputils-ping
  - bash-completion

write_files:
  # ç¦ç”¨ Cloud-Init è‡ªå¸¦çš„ç½‘ç»œé…ç½®ï¼Œé˜²æ­¢å†²çª
  - path: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
    content: "network: {config: disabled}"

  # Terraform ä¼šåœ¨ç”Ÿæˆ ISO å‰ï¼Œéå† cluster_nodes å˜é‡ï¼ŒæŠŠæ‰€æœ‰èŠ‚ç‚¹éƒ½å†™è¿›å»
  - path: /etc/hosts.cluster
    content: |
      127.0.0.1 localhost
      ::1 localhost
      
      # Cluster Nodes
      %{for id, node in var.cluster_nodes~}
      ${var.network_prefix}.${node.ip_last_byte} ${node.hostname}
      %{endfor~}

  # å†™å…¥è‡ªåŠ¨é…ç½®è„šæœ¬
  - path: /usr/local/bin/auto-net.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      sleep 2
      
      # æ³¨æ„ï¼šåœ¨ Terraform EOF ä¸­ï¼ŒShell çš„ $ ä¸éœ€è¦è½¬ä¹‰ï¼Œé™¤éåé¢ç´§è·Ÿ {
      IFACE=$(ip -o link show | awk -F': ' '$2 != "lo" && $2 !~ /docker|veth|cni|virbr|cali|flannel/ {print $2; exit}')
      
      if [ -z "$IFACE" ]; then
        echo "Error: No physical interface found!"
        exit 1
      fi
      
      echo "Found interface: $IFACE"
      
      mkdir -p /etc/systemd/network
      
      cat <<'NET' > /etc/systemd/network/10-static.network
      [Match]
      Name=$IFACE
      
      [Network]
      Address=${var.network_prefix}.${each.value.ip_last_byte}/24
      Gateway=${var.gateway}
      DNS=${var.dns_servers[0]}
      DNS=${var.dns_servers[1]}
      IPv6AcceptRA=no
      NET
      
      sed -i "s/\$IFACE/$IFACE/g" /etc/systemd/network/10-static.network

      rm -f /etc/netplan/*.yaml
      systemctl enable systemd-networkd
      systemctl restart systemd-networkd
      
      ip link set "$IFACE" up

runcmd:
  - [ bash, /usr/local/bin/auto-net.sh ]
  - [ systemctl, enable, --now, qemu-guest-agent ]
  - [ cp, /etc/hosts.cluster, /etc/hosts ]
  - [ rm, /etc/ssh/sshd_config.d/60-cloudimg-settings.conf ]
EOF
}

## è™šæ‹Ÿæœºå¼€å…³æœºçŠ¶æ€æ§åˆ¶
# ä¸€é”®å¼€/å…³æœº terraform apply -var="vm_state=true/false"
variable "vm_state" {
  type    = bool
  default = true # é»˜è®¤æ˜¯å¼€å¯
}

### å®šä¹‰è™šæ‹Ÿæœºå®ä¾‹ -----------------------------------------------------------------
resource "libvirt_domain" "terraform_test" {
  for_each = var.cluster_nodes
  name     = each.value.hostname # è™šæ‹Ÿæœºæ˜¾ç¤ºåç§°
  running  = var.vm_state        # æ ¹æ®å˜é‡æ§åˆ¶è™šæ‹Ÿæœºå¼€å…³æœºçŠ¶æ€
  memory   = "2048"              # å†…å­˜å¤§å° (MB)
  vcpu     = 2                   # CPU æ ¸å¿ƒæ•°

  # # æ ¸å¿ƒé…ç½®ï¼šå°†ä¸Šé¢å®šä¹‰çš„ Cloud-Init ISO æŒ‚è½½åˆ°è¿™å°è™šæ‹Ÿæœºä¸Š
  # cloudinit = libvirt_cloudinit_disk.commoninit.id
  cloudinit = libvirt_cloudinit_disk.commoninit[each.key].id

  ## é…ç½®ç½‘ç»œæ¥å£
  network_interface {
    # network_name = "default"    # ä½¿ç”¨ KVM é»˜è®¤çš„ NAT ç½‘ç»œ
    bridge         = "br0" # æ¡¥æ¥æ¨¡å¼ï¼Œ "br0" å¿…é¡»æ˜¯å®¿ä¸»æœºä¸ŠçœŸå®å­˜åœ¨çš„ç½‘æ¡¥åç§°
    wait_for_lease = false # ç­‰å¾…è™šæ‹Ÿæœºå¯åŠ¨å¹¶åˆ†é…åˆ° IPï¼Œè¿™å¯¹è‡ªåŠ¨åŒ–åç»­æ“ä½œéå¸¸æœ‰ç”¨ï¼Œéœ€è¦ç¡®ä¿é•œåƒä¸­å®‰è£…å¹¶å¯åŠ¨äº† qemu-guest-agent æœåŠ¡ï¼Œå¦åˆ™ä¼šè¶…æ—¶å¤±è´¥ï¼Œæˆ–è€…è®¾ç½®ä¸º false
  }

  ## æŒ‚è½½å¯¹åº”çš„ç¡¬ç›˜
  disk {
    volume_id = libvirt_volume.Disk[each.key].id # å…³è”ä¸Šé¢å®šä¹‰çš„ç¡¬ç›˜èµ„æºï¼Œæ ¹æ®ç´¢å¼•å·ä¸€ä¸€å¯¹åº”  
  }
  # libvirt_volume.Disk.id æ˜¯ä¸€ä¸ªå¼•ç”¨è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ‹†è§£ä¸ºä¸‰éƒ¨åˆ†æ¥çœ‹ï¼š
  # libvirt_volume (èµ„æºç±»å‹)ï¼š å‘Šè¯‰ Terraformï¼šâ€œæˆ‘è¦æ‰¾ä¸€ä¸ªå­˜å‚¨å·ï¼ˆç¡¬ç›˜ï¼‰ç±»å‹çš„èµ„æºâ€ã€‚
  # Disk (èµ„æºåç§°)ï¼š è¿™æ˜¯è‡ªå®šä¹‰çš„åå­—ã€‚
  # .id (å±æ€§)ï¼š è¿™æ˜¯ç»“æœã€‚å½“ Terraform åˆ›å»ºå®Œé‚£ä¸ªç¡¬ç›˜åï¼ŒLibvirt ä¼šç»™é‚£ä¸ªç¡¬ç›˜åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ˆé€šå¸¸æ˜¯æ–‡ä»¶è·¯å¾„æˆ– UUIDï¼‰ã€‚.id å°±æ˜¯è®© Terraform è‡ªåŠ¨æŠŠè¿™ä¸ªâ€œèº«ä»½è¯å·â€å¡«åˆ°è¿™é‡Œã€‚

  ## é…ç½®å›¾å½¢ç•Œé¢
  # ä¸è¿‡åœ¨çœŸå®çš„å·¥ä½œåœºæ™¯ä¸­ï¼Œå®Œå…¨ä¸éœ€è¦ã€ç”šè‡³ä¼šåˆ»æ„ç¦æ­¢é…ç½®å›¾å½¢ç•Œé¢
  # graphics {
  #   type        = "spice"     # SPICE æ˜¯ KVM/QEMU ä½“ç³»ä¸­æœ€å¸¸ç”¨ã€æ€§èƒ½æœ€å¥½çš„æ˜¾ç¤ºåè®®
  #   listen_type = "address"    # ç›‘å¬åœ°å€ï¼Œé»˜è®¤æœ¬åœ°
  #   autoport    = true  # è‡ªåŠ¨åˆ†é…ç«¯å£
  # }

  ## é…ç½®ä¸²å£æ§åˆ¶å° (Serial Console)
  # å³ä½¿ SSH æŒ‚äº†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ virsh console è¿æ¥è™šæ‹Ÿæœº
  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

}

resource "local_file" "ansible_inventory" {
  content = <<CFG
[masters]
%{ for id, node in var.cluster_nodes ~}
%{ if node.hostname == "kmaster" ~}
${node.hostname} ansible_host=${var.network_prefix}.${node.ip_last_byte} ansible_user=libix ansible_ssh_private_key_file=~/.ssh/id_ed25519
%{ endif ~}
%{ endfor ~}

[workers]
%{ for id, node in var.cluster_nodes ~}
%{ if node.hostname != "kmaster" ~}
${node.hostname} ansible_host=${var.network_prefix}.${node.ip_last_byte} ansible_user=libix ansible_ssh_private_key_file=~/.ssh/id_ed25519
%{ endif ~}
%{ endfor ~}

[k8s:children]
masters
workers
CFG

  filename = "${path.module}/ansible/inventory.ini"
}

```

## ansible.cfg

/terraform/ansible/ansible.cfg

```bash
[defaults]
inventory = inventory.ini
host_key_checking = False
deprecation_warnings = False
```

## k8s_init.yml

```bash
---
# ============================================================
### åŸºç¡€ç¯å¢ƒåˆå§‹åŒ– (å¹‚ç­‰åŒ–è®¾è®¡)
# ============================================================
- hosts: all
  become: yes
  vars:
    # é”å®š K8s ç‰ˆæœ¬ï¼Œé˜²æ­¢è‡ªåŠ¨å‡çº§å¯¼è‡´ä¸å…¼å®¹
    k8s_version: "1.31"
  tasks:
    - name: åŸºç¡€ç¯å¢ƒ - ç¦ç”¨ Swap
      shell: |
        swapoff -a
        sed -i '/swap/d' /etc/fstab
      # åªæœ‰å½“ swap å¼€å¯æ—¶æ‰è¿è¡Œ (é€šè¿‡æŸ¥çœ‹ /proc/swaps æ˜¯å¦æœ‰å†…å®¹)
      when: ansible_swaptotal_mb > 0

    - name: åŸºç¡€ç¯å¢ƒ - é…ç½®å†…æ ¸æ¨¡å—
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter
    
    - name: åŸºç¡€ç¯å¢ƒ - åŠ è½½å†…æ ¸æ¨¡å—
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: åŸºç¡€ç¯å¢ƒ - é…ç½®ç½‘ç»œå‚æ•° (sysctl)
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/k8s.conf
        reload: yes
      loop:
        - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { key: 'net.ipv4.ip_forward', value: '1' }

    - name: è½¯ä»¶æº - å®‰è£…ä¾èµ–å·¥å…·
      apt:
        name: [apt-transport-https, ca-certificates, curl, gpg]
        state: present
        update_cache: yes

    - name: è½¯ä»¶æº - å‡†å¤‡ Keyring ç›®å½•
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: è½¯ä»¶æº - æ·»åŠ  K8s GPG Key
      get_url:
        url: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/Release.key"
        dest: /etc/apt/keyrings/kubernetes-apt-keyring.asc
        mode: '0644'
        force: no # å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ä¸”æœªæŸåï¼Œä¸é‡æ–°ä¸‹è½½

    - name: è½¯ä»¶æº - æ·»åŠ  K8s ä»“åº“
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.asc] https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/ /"
        filename: kubernetes
        state: present

    - name: å®‰è£…æ ¸å¿ƒç»„ä»¶
      apt:
        name: [containerd, kubelet, kubeadm, kubectl, conntrack, socat]
        state: present


    ### é…ç½® Containerd èµ°å®¿ä¸»æœºä»£ç†
    - name: åˆ›å»º Containerd Service ç›®å½•
      file:
        path: /etc/systemd/system/containerd.service.d
        state: directory

    - name: æ³¨å…¥ HTTP ä»£ç†è®¾ç½®
      copy:
        dest: /etc/systemd/system/containerd.service.d/http-proxy.conf
        content: |
          [Service]
          Environment="HTTP_PROXY=http://192.168.0.5:7897"
          Environment="HTTPS_PROXY=http://192.168.0.5:7897"
          # NO_PROXY éå¸¸é‡è¦ï¼åƒä¸‡ä¸èƒ½æŠŠ K8s å†…éƒ¨æµé‡å‘ç»™ä»£ç†
          Environment="NO_PROXY=localhost,127.0.0.1,10.244.0.0/16,10.96.0.0/12,192.168.0.0/24,.svc,.cluster.local"

    - name: é”å®šè½¯ä»¶ç‰ˆæœ¬
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl

    # --- Containerd é…ç½®å¹‚ç­‰åŒ–æ ¸å¿ƒ ---
    - name: Containerd - åˆ›å»ºé…ç½®ç›®å½•
      file:
        path: /etc/containerd
        state: directory

    - name: Containerd - æ£€æŸ¥é…ç½®æ–‡ä»¶çŠ¶æ€
      stat:
        path: /etc/containerd/config.toml
      register: containerd_config_file

    - name: Containerd - ç”Ÿæˆé»˜è®¤é…ç½® (ä»…å½“æ–‡ä»¶ç¼ºå¤±æ—¶)
      shell: containerd config default > /etc/containerd/config.toml
      when: not containerd_config_file.stat.exists
      notify: é‡å¯ Containerd

    - name: Containerd - å¼€å¯ SystemdCgroup (ç²¾å‡†æ›¿æ¢)
      replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'
      notify: é‡å¯ Containerd

  handlers:
    - name: é‡å¯ Containerd
      service:
        name: containerd
        state: restarted
        daemon_reload: yes

# ============================================================
### Master åˆå§‹åŒ– & ä»¤ç‰Œæ ‡å‡†åŒ–åˆ†å‘
# ============================================================
- hosts: masters
  become: yes
  tasks:
    - name: æ£€æŸ¥é›†ç¾¤çŠ¶æ€
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubeadm_init_stat

    - name: åˆå§‹åŒ– Master
      command: >
        kubeadm init 
        --pod-network-cidr=10.244.0.0/16 
        --apiserver-advertise-address={{ ansible_host }}
      when: not kubeadm_init_stat.stat.exists

    # --- é…ç½®æ™®é€šç”¨æˆ· kubectl æƒé™ ---
    - name: åˆ›å»ºç”¨æˆ· .kube ç›®å½•
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: å¤åˆ¶ admin.conf
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ ansible_user }}/.kube/config"
        remote_src: yes
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    # --- Calico ç½‘ç»œæ’ä»¶ (å¹‚ç­‰æ€§å¤„ç†) ---
    - name: ä¸‹è½½ Calico Manifest
      get_url:
        url: https://raw.githubusercontent.com/projectcalico/calico/v3.29.1/manifests/calico.yaml
        dest: /root/calico.yaml
      
    - name: é…ç½® Calico - å¯ç”¨ CIDR å˜é‡
      replace:
        path: /root/calico.yaml
        regexp: '#\s*- name: CALICO_IPV4POOL_CIDR'
        replace: '- name: CALICO_IPV4POOL_CIDR'

    - name: é…ç½® Calico - è®¾ç½® Pod ç½‘æ®µ
      replace:
        path: /root/calico.yaml
        regexp: '#\s*value: "192.168.0.0/16"'
        replace: '  value: "10.244.0.0/16"'

    - name: åº”ç”¨ Calico
      command: kubectl apply -f /root/calico.yaml --kubeconfig /etc/kubernetes/admin.conf
      register: calico_result
      changed_when: "'created' in calico_result.stdout or 'configured' in calico_result.stdout"

    # --- ä»¤ç‰Œä½œç”¨åŸŸæ ‡å‡†åŒ– (Standardization) ---
    - name: ç”Ÿæˆ Join Token
      command: kubeadm token create --print-join-command --kubeconfig /etc/kubernetes/admin.conf
      register: join_command_raw
      # å³ä½¿ Master å·²ç»åˆå§‹åŒ–è¿‡ï¼Œä¸ºäº†è®©æ–°èŠ‚ç‚¹åŠ å…¥ï¼Œè¿™é‡Œæ€»æ˜¯ç”Ÿæˆä¸€ä¸ªæ–° token æ¯”è¾ƒä¿é™©
      # æˆ–è€…ä½¿ç”¨ kubeadm token list æ£€æŸ¥
    
    - name: å°† Token æ³¨å†Œåˆ°å…¨å±€å†…å­˜å¯¹è±¡ (Magic Step)
      add_host:
        name: "K8S_TOKEN_HOLDER"
        token: "{{ join_command_raw.stdout }}"
      # 'K8S_TOKEN_HOLDER' æ˜¯ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸè´¯ç©¿æ•´ä¸ª playbook æ‰§è¡Œè¿‡ç¨‹

# ============================================================
### Worker èŠ‚ç‚¹åŠ å…¥
# ============================================================
- hosts: workers
  become: yes
  tasks:
    - name: æ£€æŸ¥èŠ‚ç‚¹åŠ å…¥çŠ¶æ€
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf

    - name: æ‰§è¡ŒåŠ å…¥å‘½ä»¤ (ä»å…¨å±€å¯¹è±¡è·å–)
      command: "{{ hostvars['K8S_TOKEN_HOLDER']['token'] }}"
      when: not kubelet_conf.stat.exists
```



# KVM

## net_init.sh

```bash
#!/bin/bash
set -e

GATEWAY="192.168.0.1"
DNS1="192.168.1.1"
DNS2="192.168.0.1"
PREFIX="24"

declare -A CLUSTER_MAP
CLUSTER_MAP["kmaster"]="192.168.0.10"
CLUSTER_MAP["knode1"]="192.168.0.11"
CLUSTER_MAP["knode2"]="192.168.0.12"
CLUSTER_MAP["storage-node"]="192.168.0.20"

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m'

if [ "$(id -u)" != "0" ]; then
   echo -e "${RED}é”™è¯¯: è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬${NC}"
   exit 1
fi

echo -e "${YELLOW}>>> å½“å‰è„šæœ¬å·²é¢„å®šä¹‰ä»¥ä¸‹èŠ‚ç‚¹é…ç½®ï¼š${NC}"
for name in "${!CLUSTER_MAP[@]}"; do
    echo -e " - ${GREEN}$name${NC} \t(IP: ${CLUSTER_MAP[$name]})"
done
echo "----------------------------------------"

while true; do
    read -p "è¯·è¾“å…¥å½“å‰æœºå™¨çš„è§’è‰²åç§° (ä¾‹å¦‚ kmaster): " TARGET_NAME
    
    if [[ -v CLUSTER_MAP["$TARGET_NAME"] ]]; then
        TARGET_IP=${CLUSTER_MAP["$TARGET_NAME"]}
        echo -e "å·²é€‰ä¸­: ${GREEN}$TARGET_NAME${NC} -> å°†é…ç½® IP ä¸º: ${YELLOW}$TARGET_IP${NC}"
        read -p "ç¡®è®¤ç»§ç»­å—? [y/N]: " CONFIRM
        if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
            break
        fi
    else
        echo -e "${RED}é”™è¯¯: è¾“å…¥çš„ä¸»æœºå '$TARGET_NAME' ä¸åœ¨é¢„å®šä¹‰åˆ—è¡¨ä¸­ï¼Œè¯·é‡è¯•ã€‚${NC}"
    fi
done

IFACE=$(ip -o link show | awk -F': ' '$2 != "lo" && $2 !~ /docker|veth|cni|virbr|cali|flannel/ {print $2; exit}')

if [ -z "$IFACE" ]; then
    echo -e "${RED}æœªæ£€æµ‹åˆ°ç‰©ç†ç½‘å¡ï¼${NC}"
    exit 1
fi
echo -e "ä½¿ç”¨ç½‘å¡æ¥å£: ${GREEN}$IFACE${NC}"


echo "è®¾ç½®ç³»ç»Ÿä¸»æœºå..."
hostnamectl set-hostname "$TARGET_NAME"
echo "$TARGET_NAME" > /etc/hostname


if [ -f /etc/os-release ]; then
    . /etc/os-release
else
    echo "æ— æ³•æ£€æµ‹ç³»ç»Ÿç‰ˆæœ¬"
    exit 1
fi

echo -e "æ£€æµ‹åˆ°ç³»ç»Ÿ: $ID, æ­£åœ¨å†™å…¥ç½‘ç»œé…ç½®..."

case $ID in
    ubuntu|debian)

        mkdir -p /etc/netplan/backup
        mv /etc/netplan/*.yaml /etc/netplan/backup/ 2>/dev/null || true
        
        cat <<EOF > /etc/netplan/01-static.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    $IFACE:
      dhcp4: no
      addresses:
        - $TARGET_IP/$PREFIX
      routes:
        - to: default
          via: $GATEWAY
      nameservers:
        addresses: [$DNS1, $DNS2]
EOF
        chmod 600 /etc/netplan/01-static.yaml
        netplan apply
        echo -e "${GREEN}Netplan é…ç½®å·²ç”Ÿæ•ˆ${NC}"
        ;;

    centos|rhel|rocky|almalinux)

        systemctl start NetworkManager
        nmcli con mod "$IFACE" ipv4.addresses "$TARGET_IP/$PREFIX"
        nmcli con mod "$IFACE" ipv4.gateway "$GATEWAY"
        nmcli con mod "$IFACE" ipv4.dns "$DNS1 $DNS2"
        nmcli con mod "$IFACE" ipv4.method manual
        nmcli con mod "$IFACE" connection.autoconnect yes
        
        nmcli con down "$IFACE" && nmcli con up "$IFACE"
        echo -e "${GREEN}nmcli é…ç½®å·²ç”Ÿæ•ˆ${NC}"
        ;;
    *)
        echo -e "${RED}ä¸æ”¯æŒçš„ç³»ç»Ÿ: $ID${NC}"
        exit 1
        ;;
esac


echo "æ­£åœ¨æ›´æ–° /etc/hosts ..."
cp /etc/hosts /etc/hosts.bak

# æ¸…ç†åˆ—è¡¨ï¼Œé˜²æ­¢é‡å¤å®šä¹‰
sed -i '/127.0.1.1/d' /etc/hosts
sed -i '/# K8s-Cluster-Nodes/d' /etc/hosts

for name in "${!CLUSTER_MAP[@]}"; do
    ip=${CLUSTER_MAP[$name]}
    sed -i "/$ip/d" /etc/hosts
done

sed -i "1i 127.0.1.1\t$TARGET_NAME" /etc/hosts

echo -e "\n# K8s-Cluster-Nodes" >> /etc/hosts
for name in "${!CLUSTER_MAP[@]}"; do
    echo -e "${CLUSTER_MAP[$name]}\t$name" >> /etc/hosts
done

echo -e "${GREEN}>>> é…ç½®å®Œæˆï¼${NC}"
echo -e "å½“å‰èŠ‚ç‚¹: $TARGET_NAME ($TARGET_IP)"
echo -e "Hosts æ–‡ä»¶å·²åŒ…å«é›†ç¾¤å†… ${#CLUSTER_MAP[@]} ä¸ªèŠ‚ç‚¹è®°å½•ã€‚"
```

# Git

## update.sh

```bash
#!/bin/bash

if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
  echo "âŒ é”™è¯¯: å½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“ã€‚"
  exit 1
fi

TARGET_DIR="./_posts"
file="$1"

# ==========================================
# åˆ†æ”¯ 1: æŒ‡å®šäº†æ–‡ä»¶ -> å¤„ç†æ–‡ä»¶ + Git
# ==========================================
if [[ -n "$file" ]]; then

    if [[ ! -f "$file" ]]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶ '$file' ä¸å­˜åœ¨ã€‚"
        exit 1
    fi

    if [[ ! -d "$TARGET_DIR" ]]; then
        mkdir -p "$TARGET_DIR"
    fi

    filename=$(basename -- "$file")
    timestamp_regex="^[0-9]{2}-[0-9]{2}-[0-9]{2}-"

    if [[ "$filename" =~ $timestamp_regex ]]; then
        final_name="$filename"
    else
        date_prefix=$(date '+%y-%m-%d')
        final_name="${date_prefix}-${filename}"
        echo "ğŸ”„ é‡å‘½å: $filename -> $final_name"
    fi

    # 4. ç§»åŠ¨æ–‡ä»¶åˆ° _posts
    target_path="${TARGET_DIR}/${final_name}"
    
    if [[ "$(readlink -f "$file")" != "$(readlink -f "$target_path")" ]]; then
        mv "$file" "$target_path"
    fi

    echo "ğŸ” æ£€æŸ¥ç¬”è®°å¤´éƒ¨ä¿¡æ¯ (Front Matter)..."
    
    current_date=$(date -d "yesterday" '+%Y-%m-%d')

    # æ£€æµ‹æ–‡ä»¶ç¬¬ä¸€è¡Œæ˜¯å¦ä¸º ---
    first_line=$(head -n 1 "$target_path")

    if [[ "$first_line" != "---" ]]; then
        echo "âš ï¸  æœªæ£€æµ‹åˆ° YAML å¤´éƒ¨ï¼Œæ­£åœ¨åˆ›å»º..."
        
        # è¯¢é—®ç”¨æˆ·è¾“å…¥
        read -p "ğŸ“ è¯·è¾“å…¥æ ‡é¢˜ (title): " input_title
        read -p "ğŸ·ï¸  è¯·è¾“å…¥æ ‡ç­¾ (blog-label): " input_label
        
        # åˆ›å»ºä¸´æ—¶å¤´éƒ¨æ–‡ä»¶
        cat > header_tmp.txt <<EOF
---
layout: default
title:   "$input_title"
date:   $current_date
blog-label: $input_label
---

EOF
        # å°†å¤´éƒ¨æ‹¼æ¥åœ¨åŸå†…å®¹å‰é¢
        cat "$target_path" >> header_tmp.txt
        mv header_tmp.txt "$target_path"
        echo "âœ… å·²æ·»åŠ å®Œæ•´å¤´éƒ¨ã€‚"
        
    else
        # --- æ–‡ä»¶å·²æœ‰å¤´éƒ¨ï¼Œæ£€æŸ¥ç¼ºå¤±é¡¹ ---
        
        # 1. æ£€æŸ¥ layout (è‡ªåŠ¨æ·»åŠ  default)
        if ! grep -q "^layout:" "$target_path"; then
            sed -i "1a layout: default" "$target_path"
            echo "â• è‡ªåŠ¨æ·»åŠ : layout: default"
        fi

        # 2. æ£€æŸ¥ date (è‡ªåŠ¨æ·»åŠ ä»Šå¤©)
        if ! grep -q "^date:" "$target_path"; then
            sed -i "1a date:   $current_date" "$target_path"
            echo "â• è‡ªåŠ¨æ·»åŠ : date: $current_date"
        fi

        # 3. æ£€æŸ¥ title (è¯¢é—®)
        if ! grep -q "^title:" "$target_path"; then
            read -p "ğŸ“ æ£€æµ‹ç¼ºå°‘ titleï¼Œè¯·è¾“å…¥: " input_title
            sed -i "1a title:  \"$input_title\"" "$target_path"
        fi

        # 4. æ£€æŸ¥ blog-label (è¯¢é—®)
        if ! grep -q "^blog-label:" "$target_path"; then
            read -p "ğŸ·ï¸  æ£€æµ‹ç¼ºå°‘ blog-labelï¼Œè¯·è¾“å…¥: " input_label
            sed -i "1a blog-label: $input_label" "$target_path"
        fi
    fi

    # 5. Git æ·»åŠ ç‰¹å®šæ–‡ä»¶
    #git add "$target_path"
    #default_msg="Add post: $final_name"
    git add .
    default_msg="Added a new note $target_path"

# ==========================================
# åˆ†æ”¯ 2: æœªæŒ‡å®šæ–‡ä»¶ -> å…¨å±€åŒæ­¥
# ==========================================
else
    echo "ğŸ“‚ æœªæŒ‡å®šå…·ä½“æ–‡ä»¶ï¼Œæ‰§è¡Œå…¨å±€ Git åŒæ­¥..."
    git add .
    default_msg="Updated some content $(date -d "yesterday" '+%Y/%m/%d-%H:%M:%S')"
fi

# ==========================================
# â˜ï¸ Git æäº¤æµç¨‹
# ==========================================
echo "----------------------------------------"

if git diff-index --quiet HEAD --; then
    echo "â„¹ï¸  æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ (Nothing to commit)ã€‚"
    exit 0
fi

echo "ğŸ“ è¯·è¾“å…¥æäº¤ä¿¡æ¯ (å›è½¦ä½¿ç”¨é»˜è®¤å€¼):"
read -p "Commit msg [$default_msg] > " user_msg

if [[ -z "$user_msg" ]]; then
    commit_msg="$default_msg"
else
    commit_msg="$user_msg"
fi

if git commit -m "$commit_msg"; then
    echo "âœ… æäº¤æˆåŠŸ"
else
    echo "âŒ æäº¤å¤±è´¥"
    exit 1
fi

echo "ğŸš€ æ­£åœ¨æ¨é€..."
if git push; then
    echo "ğŸ‰ å®Œæˆ!" 
else
    echo "âŒ æ¨é€å¤±è´¥"
    exit 1
fi
```



# Linux Desktop

## .xinitrc

```bash
# ä¸å¼€å¯ä¼šå¯¼è‡´åº”ç”¨å¯åŠ¨æ—¶å¡ä½,æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†å»¶è¿Ÿ
/usr/libexec/xdg-desktop-portal &
/usr/libexec/xdg-desktop-portal-gtk &

# picom å¿…é¡»ä¿æŒåå°å¸¸é©»è¿è¡Œï¼Œä½œä¸º maim çš„é€‰åŒºæ¡†éœ€è¦ compositor çš„å®æ—¶æ¸²æŸ“æ”¯æŒ
# ~/.config/picom/picom.conf é…ç½®äº†çª—å£çš„è¾¹è§’å¼§åº¦
picom --backend xrender --config ~/.config/picom/picom.conf &

fcitx5 &
dunst &
#conky &
xrandr --output HDMI-A-0 --mode 1920x1080 --output eDP --off
clash-verge &
feh --bg-scale /home/libix/Pictures/linus-nvidia-e1609165140132-1024x579.jpg

#exec openbox-session
exec i3

```



## picom.conf

```bash
backend = "glx";
vsync = true;

glx-no-stencil = true;
glx-no-rebind-pixmap = true;
glx-copy-from-front = false;
use-damage = true;

unredir-if-possible = true;
unredir-if-possible-exclude = [
    "class_g = 'Vlc'"
];
        
corner-radius = 0;

detect-rounded-corners = true;
rounded-corners-exclude = [
  "window_type = 'dock'",
  "window_type = 'desktop'"
];

shadow = true;
shadow-radius = 18;
shadow-opacity = 0.4;
shadow-offset-x = -15;
shadow-offset-y = -15;

shadow-exclude = [
  "name = 'Notification'",
  "class_g = 'Conky'",
  "class_g = 'fcitx'",
  "class_g = 'fcitx5'",
  "_GTK_FRAME_EXTENTS@:c",
  "class_g = 'firefox' && argb",
  "class_g = 'Google-chrome' && argb"
];

fading = true;
fade-in-step = 0.03;
fade-out-step = 0.03;
fade-delta = 4;
no-fading-openclose = false;

active-opacity = 1.0;
inactive-opacity = 0.90;
frame-opacity = 1.0;
inactive-opacity-override = false;

opacity-rule = [
  "100:class_g = 'Firefox'",
  "100:class_g = 'Google-chrome'",
  "100:class_g = 'Chromium'",
  "100:class_g = 'Vlc'",
  "100:class_g = 'fcitx5'",
  "100:fullscreen"
];

blur-method = "dual_kawase";
blur-strength = 5;

blur-background-exclude = [
  "window_type = 'dock'",
  "window_type = 'desktop'",
  "_GTK_FRAME_EXTENTS@:c"
];

wintypes:
{
  tooltip = { fade = true; shadow = true; opacity = 0.95; focus = true; full-shadow = false; };
  dock = { shadow = false; clip-shadow-above = true; }
  dnd = { shadow = false; }
  popup_menu = { opacity = 1.0; shadow = false; }
  dropdown_menu = { opacity = 1.0; shadow = false; }
  menu = { opacity = 1.0; shadow = false; }
};

```

## config

```bash
set $mod Mod4

font pango:SF Mono 9

exec --no-startup-id dex --autostart --environment i3

exec --no-startup-id xss-lock --transfer-sleep-lock -- i3lock --nofork

exec --no-startup-id nm-applet

set $refresh_i3status killall -SIGUSR1 i3status
bindsym XF86AudioRaiseVolume exec --no-startup-id pactl set-sink-volume @DEFAULT_SINK@ +10% && $refresh_i3status
bindsym XF86AudioLowerVolume exec --no-startup-id pactl set-sink-volume @DEFAULT_SINK@ -10% && $refresh_i3status
bindsym XF86AudioMute exec --no-startup-id pactl set-sink-mute @DEFAULT_SINK@ toggle && $refresh_i3status
bindsym XF86AudioMicMute exec --no-startup-id pactl set-source-mute @DEFAULT_SOURCE@ toggle && $refresh_i3status

floating_modifier $mod

# move tiling windows via drag & drop by left-clicking into the title bar,
# or left-clicking anywhere into the window while holding the floating modifier.
tiling_drag modifier titlebar

bindsym $mod+t exec i3-sensible-terminal

# æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯ä»ªè¡¨ç›˜
bindsym $mod+i exec --no-startup-id ~/.config/i3/sys_info.sh

# è·³è½¬æ–°æ¡Œé¢
bindsym $mod+Return exec --no-startup-id ~/.config/i3/create_ws.sh

# kill focused window
bindsym $mod+q kill

# start dmenu (a program launcher)
bindsym $mod+slash exec --no-startup-id dmenu_run

# ä½¿ç”¨ Win + æ–¹å‘é”® åˆ‡æ¢çª—å£ç„¦ç‚¹
bindsym $mod+Left focus left
bindsym $mod+Down focus down
bindsym $mod+Up focus up
bindsym $mod+Right focus right

# alternatively, you can use the cursor keys:
bindsym $mod+Shift+Left move left
bindsym $mod+Shift+Down move down
bindsym $mod+Shift+Up move up
bindsym $mod+Shift+Right move right

# enter fullscreen mode for the focused container
bindsym Control+Tab fullscreen toggle

# change container layout (stacked, tabbed, toggle split)
bindsym $mod+s layout stacking
bindsym $mod+w layout tabbed
bindsym $mod+e layout toggle split

# åˆ‡æ¢å½“å‰çª—å£çš„å¹³é“º/æµ®åŠ¨çŠ¶æ€
bindsym $mod+Shift+space floating toggle

# switch to workspace
# è¿™é‡Œçš„ -h string:x-dunst-stack-tag:ws æ˜¯ä¸ºäº†é˜²æ­¢å¼¹çª—å †å 
bindsym $mod+1 workspace 1; exec --no-startup-id notify-send -t 800 -h string:x-dunst-stack-tag:ws "å·¥ä½œåŒº 1"
bindsym $mod+2 workspace 2; exec --no-startup-id notify-send -t 800 -h string:x-dunst-stack-tag:ws "å·¥ä½œåŒº 2"
bindsym $mod+3 workspace 3; exec --no-startup-id notify-send -t 800 -h string:x-dunst-stack-tag:ws "å·¥ä½œåŒº 3"
bindsym $mod+4 workspace 4; exec --no-startup-id notify-send -t 800 -h string:x-dunst-stack-tag:ws "å·¥ä½œåŒº 4"
bindsym $mod+5 workspace 5; exec --no-startup-id notify-send -t 800 -h string:x-dunst-stack-tag:ws "å·¥ä½œåŒº 5"
bindsym $mod+6 workspace 6; exec --no-startup-id notify-send -t 800 -h string:x-dunst-stack-tag:ws "å·¥ä½œåŒº 6"
bindsym $mod+7 workspace 7; exec --no-startup-id notify-send -t 800 -h string:x-dunst-stack-tag:ws "å·¥ä½œåŒº 7"
bindsym $mod+8 workspace 8; exec --no-startup-id notify-send -t 800 -h string:x-dunst-stack-tag:ws "å·¥ä½œåŒº 8"
bindsym $mod+9 workspace 9; exec --no-startup-id notify-send -t 800 -h string:x-dunst-stack-tag:ws "å·¥ä½œåŒº 9"
bindsym $mod+0 workspace 10; exec --no-startup-id notify-send -t 800 -h string:x-dunst-stack-tag:ws "å·¥ä½œåŒº 10"

# move focused container to workspace
bindsym $mod+Shift+1 move container to workspace number 1
bindsym $mod+Shift+2 move container to workspace number 2
bindsym $mod+Shift+3 move container to workspace number 3
bindsym $mod+Shift+4 move container to workspace number 4
bindsym $mod+Shift+5 move container to workspace number 5
bindsym $mod+Shift+6 move container to workspace number 6
bindsym $mod+Shift+7 move container to workspace number 7
bindsym $mod+Shift+8 move container to workspace number 8
bindsym $mod+Shift+9 move container to workspace number 9
bindsym $mod+Shift+0 move container to workspace number 0

bindsym $mod+Shift+c reload

bindsym $mod+Shift+r restart

bindsym $mod+Shift+e exec "i3-nagbar -t warning -m 'You pressed the exit shortcut. Do you really want to exit i3? This will end your X session.' -B 'Yes, exit i3' 'i3-msg exit'"

# å»æ‰å¹³é“ºçª—å£çš„æ ‡é¢˜æ ï¼Œåªä¿ç•™ 1 åƒç´ çš„ç»†è¾¹æ¡†
default_border pixel 0

# å»æ‰æµ®åŠ¨çª—å£çš„æ ‡é¢˜æ ï¼Œåªä¿ç•™ 1 åƒç´ çš„ç»†è¾¹æ¡†
default_floating_border pixel 0

# Alt+Tab åˆ‡æ¢å·¥ä½œåŒº
bindsym Mod1+Tab exec --no-startup-id ~/.config/i3/switch_ws.sh next
bindsym $mod+Tab exec --no-startup-id ~/.config/i3/switch_ws.sh prev

# å…³é—­é¼ æ ‡è‡ªåŠ¨èšç„¦
focus_follows_mouse no

bindsym $mod+l exec slock

```

## dunstrc

```bash
[global]
    # === ä½ç½®ï¼šé¡¶éƒ¨å±…ä¸­ ===
    origin = top-center
    
    # åç§»é‡ï¼šæ°´å¹³0ï¼Œå‚ç›´10 (ç¨å¾®æ‚¬æµ®åœ¨å±å¹•è¾¹ç¼˜æˆ–çŠ¶æ€æ ä¸‹æ–¹)
    # ä½ å¯ä»¥æ ¹æ®ä½ çš„ i3bar é«˜åº¦è°ƒæ•´è¿™ä¸ª 10ï¼Œæ¯”å¦‚æ”¹æˆ 30 è®©å®ƒå®Œå…¨æµ®ç©º
    offset = 0x10
    
    # === å¤§å° ===
    # å®½åº¦ï¼šå›ºå®š 350px
    width = 350
    # é«˜åº¦ï¼šè‡ªåŠ¨é€‚åº”å†…å®¹
    height = 300
    
    # === å¤–è§‚ï¼šé»‘æ´é£æ ¼ ===
    # çº¯é»‘èƒŒæ™¯
    transparency = 0
    separator_color = "#333333"
    
    # æ— è¾¹æ¡† (èä¸ºä¸€ä½“)
    frame_width = 0
    
    # æå¤§çš„åœ†è§’
    corner_radius = 20
    
    # å†…è¾¹è·
    padding = 15
    horizontal_padding = 20
    
    # === æ–‡å­— ===
    font = Sans Bold 11
    # å…è®¸ Pango æ ‡è®° (ç²—ä½“ã€é¢œè‰²ç­‰)
    markup = full
    format = "%s\n%b"
    alignment = center
    # è¡Œé—´è·
    line_height = 6

[urgency_low]
    background = "#000000"
    foreground = "#888888"

[urgency_normal]
    background = "#000000"
    foreground = "#ffffff"

[urgency_critical]
    background = "#000000"
    foreground = "#ff5555"

```



# ---