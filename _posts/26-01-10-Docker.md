---
layout: default
title:   "Docker"
date:   2026-01-09
blog-label: Notes
---

# 安装 Docker

#### 下载 GPG 密钥
使用官方推荐的二进制格式 (`.gpg`)

```bash
# 确保目录存在
sudo install -m 0755 -d /etc/apt/keyrings

# 下载并转换密钥 (注意：这一步生成的是 docker.gpg)
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 赋予读取权限
sudo chmod a+r /etc/apt/keyrings/docker.gpg
```

#### 写入源列表

Docker 官方可能还没有 ` Debian 13 (Trixie)` 的仓库。为了避免 404 错误或不稳定，**强制使用 Debian 12 (bookworm) 的源**（它们是完全兼容的）。

```bash
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
  bookworm stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

#### 更新并安装
```bash
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

#### 解决权限问题
```bash
# 把当前用户加入 docker 组：
sudo usermod -aG docker $USER

# 立刻刷新组权限（不需要重启，也不需要注销）：
newgrp docker

# 验证
docker ps
```


#### 配置 Docker 走 HTTP 代理
```bash
# 创建配置目录
sudo mkdir -p /etc/systemd/system/docker.service.d

# 创建代理配置文件写入以下内容（假设你的宿主机代理端口是 `7890`，请根据实际情况修改）
sudo cat <<EOL> /etc/systemd/system/docker.service.d/http-proxy.conf
[Service]
Environment="HTTP_PROXY=http://127.0.0.1:7890"
Environment="HTTPS_PROXY=http://127.0.0.1:7890"
Environment="NO_PROXY=localhost,127.0.0.1"
EOL

# 重载并重启
sudo systemctl daemon-reload
sudo systemctl restart docker
```
*注意：如果 Docker 是在本机跑，且代理也在本机，写 `127.0.0.1` 通常没问题。但有些情况下可能需要写宿主机的局域网 IP。*




``` bash
# 确认你的当前用户 ID 是不是 1000 (通常第一个用户都是 1000)
id -u 

# 把挂载的文件所有权改为 1000:1000
# 这一步非常关键！
sudo chown -R 1000:1000 mysite.db
sudo chown -R 1000:1000 static
```

# **登录私有镜像仓库**

```bash
libix@Debian:~$ docker login --username=aoeiuv123456 crpi-bkg7bvmf5xyivcsd.cn-shanghai.personal.cr.aliyuncs.com
Password:
WARNING! Your credentials are stored unencrypted in '/home/libix/.docker/config.json'.
Configure a credential helper to remove this warning. See
https://docs.docker.com/go/credential-store/
Login Succeeded
libix@Debian:~$ 
libix@Debian:~$  docker pull crpi-bkg7bvmf5xyivcsd.cn-shanghai.personal.cr.aliyuncs.com/onlymyself/onlymyself-hub:centos-7.9.2009
centos-7.9.2009: Pulling from onlymyself/onlymyself-hub
54b4c6149867: Pull complete 
Digest: sha256:2e4251caed46d831f1300c46d04974e0d8b763f68dc69fc4845a60dbb853d011
Status: Downloaded newer image for crpi-bkg7bvmf5xyivcsd.cn-shanghai.personal.cr.aliyuncs.com/onlymyself/onlymyself-hub:centos-7.9.2009
crpi-bkg7bvmf5xyivcsd.cn-shanghai.personal.cr.aliyuncs.com/onlymyself/onlymyself-hub:centos-7.9.2009
libix@Debian:~$ 
libix@Debian:~$ docker logout crpi-bkg7bvmf5xyivcsd.cn-shanghai.personal.cr.aliyuncs.com            # 退出登录
Removing login credentials for crpi-bkg7bvmf5xyivcsd.cn-shanghai.personal.cr.aliyuncs.com
libix@Debian:~$ 

# 将镜像推送到 Registry
# 要把 hub 改为私有才能推送镜像

docker tag [镜像ID] crpi-bkg7bvmf5xyivcsd.cn-shanghai.personal.cr.aliyuncs.com/onlymyself/onlymyself-hub:[镜像版本号]
docker push crpi-bkg7bvmf5xyivcsd.cn-shanghai.personal.cr.aliyuncs.com/onlymyself/onlymyself-hub:[镜像版本号]

```

# 镜像操作

## 查看镜像

```bash
[root@docker ~]# docker images
```

## 搜索镜像

```bash
[root@docker ~]# docker search mysql
# 默认搜索的是 hub.docker.com 镜像仓库里面的
```

## 拉取镜像

```bash
[root@docker ~]# docker pull centos                    #不指定标签，默认拉取最新版本镜像
[root@docker ~]# docker pull centos:7.8.2003        #拉取指定版本镜像
具体官方有哪些版本？参考：https://hub.docker.com/_/centos/tags?page=1

[root@docker ~]# docker pull mysql
[root@docker ~]# docker images
REPOSITORY   TAG        IMAGE ID       CREATED       SIZE
mysql        latest     019814493c7a   7 weeks ago  632MB
centos       latest     5d0da3dc9764   2 years ago  231MB
centos       7.8.2003   afb6fca791e0   3 years ago  203MB
```

## 删除镜像

```bash
[root@docker ~]# docker rmi centos:7.8.2003
Untagged: centos:7.8.2003
Untagged:centos@sha256:8540a199ad51c6b7b51492fa9fee27549fd11b3bb913e888ab2ccf77cbb72cc1
Deleted: sha256:afb6fca791e071c66276202f8efca5ce3d3dc4fb218bcddff1bc565d981ddd1e
Deleted:sha256:fb82b029bea0a2a3b6a62a9c1e47e57fae2a82f629b2d1a346da4fc8fb53a0b6
[root@docker ~]# docker images
REPOSITORY   TAG       IMAGE ID       CREATED       SIZE
mysql        latest   019814493c7a   7 weeks ago   632MB
[root@docker ~]# docker rmi mysql
[root@docker ~]# docker rmi $(docker images -qa)            # 批量删除所有的镜像
```

## 导出导入镜像

把镜像保存为 tar 包拷贝到其他节点上，导入即可

```bash
[root@docker ~]# docker save mysql:latest -o mysql.tar
[root@docker ~]# ls
anaconda-ks.cfg  mysql.tar
[root@docker ~]# docker images
REPOSITORY   TAG       IMAGE ID   CREATED  SIZE
[root@docker ~]#
[root@docker ~]# docker load -i mysql.tar
18a3ada103a9: Loading layer 118.8MB/118.8MB
96549124ed74: Loading layer 11.26kB/11.26kB
331304b328ea: Loading layer 2.359MB/2.359MB
7d05fbfb31ee: Loading layer 13.85MB/13.85MB
d8fb47b60f94: Loading layer 6.656kB/6.656kB
a5d9662dde43: Loading layer 3.072kB/3.072kB
7fafcf5c6ac1: Loading layer   201MB/201MB
ec9a59df23f2: Loading layer 3.072kB/3.072kB
5458227f9e0f: Loading layer 312.7MB/312.7MB
14544546851f: Loading layer  16.9kB/16.9kB
Loaded image: mysql:latest
[root@docker ~]# docker images
REPOSITORY   TAG       IMAGE ID       CREATED       SIZE
mysql        latest    019814493c7a   7 weeks ago  632MB
[root@docker ~]# 
```

## 镜像重命名

```bash
[root@docker ~]# docker tag alpine:latest registry.cn-hangzhou.aliyuncs.com/20240310/alpine:v666
```

重命名之后会出现一个新的镜像，原镜像删除即可

## 镜像推送

镜像推送是要往自己的镜像仓库里面推送的

阿里云/华为云/docker hub

镜像推送的前提：

1. 当前推送的环境必须登录到你的私有仓库里面，才能推送。
2. 镜像必须通过 tag 改名之后，才能推送。

不同广商的个人镜像仓库的名称不同

阿里云：命名空间 个人版最多可以有3个命名空间

华为云：组织 最多可以有5个组织

docker hub：registry

```bash
[root@docker ~]# docker images
REPOSITORY   TAG       IMAGE ID       CREATED       SIZE
alpine       latest    05455a08881e   6 weeks ago  7.38MB
[root@docker ~]# docker login--username=clis*****@126.com registry.cn-hangzhou.aliyuncs.com
Password:
WARNING! Your password will be stored unencrypted in/root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store
Login Succeeded
[root@docker ~]# 

# 改名
docker tag alpine:latest registry.cn-hangzhou.aliyuncs.com/20240310/alpine:v666

# 推送
docker push registry.cn-hangzhou.aliyuncs.com/20240310/alpine:v666

若镜像是公开的，你想让别人拉取你的镜像，只需要把地址告诉别人即可。
[root@docker ~]# docker pull registry.cn-hangzhou.aliyuncs.com/20240310/alpine:v666
```

# 容器操作

## 查询容器

```bash
[root@docker ~]# docker ps            #查询当前正在运行中的容器 

[root@docker ~]# docker ps -a            #查询是当前环境所有容器（运行/非运行）
```

## 运行一个容器

```bash
[root@docker ~]# docker run centos:latest
# docker create         单单把容器创建出来，不会自动运行
# docker run         把容器创建出来之后，自动运行
[root@docker ~]# docker ps
CONTAINER ID   IMAGE     COMMAND  CREATED   STATUS    PORTS    NAMES
[root@docker ~]# docker ps -a
CONTAINER ID   IMAGE           COMMAND       CREATED          STATUS                      PORTS    NAMES
573fc0035af6  centos:latest  "/bin/bash"   25 secondsago   Exited(0) 24 seconds ago            magical_rubin
[root@docker ~]# 

这个容器使用run被创建出来之后，发现并没有运行。原因是什么？
先把它删除
docker rm 5
```

## 添加交互伪终端 -it

```bash
[root@docker ~]# docker run -t -i centos:latest 
[root@0f1e3a59c7f5 /]# ls
bin  dev  etc home  lib  lib64 lost+found  media  mnt opt  proc  root run  sbin  srv sys  tmp  usr var
[root@0f1e3a59c7f5 /]# cd /tmp/ 
[root@0f1e3a59c7f5 tmp]# ls
bin  dev  etc home  lib  lib64 lost+found  media  mnt opt  proc  root run  sbin  srv sys  tmp  usr var
[root@0f1e3a59c7f5 tmp]# 
[root@0f1e3a59c7f5 tmp]# exit
exit
[root@docker ~]# docker ps
CONTAINER ID   IMAGE     COMMAND  CREATED   STATUS    PORTS    NAMES
[root@docker ~]# docker ps -a
CONTAINER ID   IMAGE           COMMAND       CREATED              STATUS                      PORTS     NAMES
0f1e3a59c7f5  centos:latest  "/bin/bash"   About aminute ago   Exited(0) 11 seconds ago            ecstatic_boyd
```

这时候退出，你会发现，容器也随之关闭了，这并不是我们想要的效果。哪怕我退出容器，它也要持续运行。先删除容器。

## 添加持续运行 --restart always

```bash
[root@docker ~]# docker run -t -i --restart always centos:latest 
[root@632c50a64bb7 /]# ls
bin  dev  etc home  lib  lib64 lost+found  media  mnt opt  proc  root run  sbin  srv sys  tmp  usr var
[root@632c50a64bb7 /]# exit
exit
[root@docker ~]# docker ps
CONTAINER ID   IMAGE           COMMAND       CREATED         STATUS        PORTS     NAMES
632c50a64bb7  centos:latest  "/bin/bash"   7 secondsago   Up 1 second             vibrant_chaum
[root@docker ~]# 
```

能不能创建容器之后，别自动进入容器，让容器在后端运行，不要直接进入。

## 添加后端运行参数 -d

```bash
[root@docker ~]# docker run -t -i -d --restart always centos:latest
42def28f6d35ab31d2e855a4f718db89a6b208bb4655f0e85a95beedf8e47675
[root@docker ~]# docker ps
CONTAINER ID  IMAGE      COMMAND    CREATED     STATUS     PORTS   NAMES
42def28f6d35 centos:latest "/bin/bash"  3 secondsago  Up 3 seconds       nifty_nobel
[root@docker ~]# 
```

## 进入容器

进入容器有两种方法：

attach：仅能进入默认进程为 /bin/bash或 /bin/sh 的容器，通过attach进入容器，之后 exit 退出，那么容器会重启

exec：所有容器都可以进入 docker exec -ti 4 /bin/bash（推荐）

## 自定义容器名称 --name

```bash
[root@docker ~]# docker run -tid --name os1 --restart always centos:latest 
[root@docker ~]# docker rename os1 os666        # 为容器改名
```

## 删除容器

```bash
[root@docker ~]# docker rm -f b1 
# 可以用 id 删除，但是必须保证唯一

[root@docker ~]# docker rm -f os3 
# 也可以用容器名字删除。
```

## 批量删除

```bash
[root@docker ~]# docker rm -f $(docker ps -qa)
```

## 创建一个临时容器 --rm

退出即自动删除

```bash
[root@docker ~]# docker run -ti --name os1--rm centos
[root@a67e5ff7c4af /]# ls
bin  dev  etc home  lib  lib64 lost+found  media  mnt opt  proc  root run  sbin  srv sys  tmp  usr var
[root@a67e5ff7c4af /]# exit
exit
[root@docker ~]# docker ps -a
CONTAINER ID   IMAGE     COMMAND  CREATED   STATUS    PORTS    NAMES
[root@docker ~]# 
```

## 指定容器生命周期

```bash
[root@docker ~]# docker run -tid --name os1 centos:latest sleep 30
[root@docker ~]# docker ps -a
CONTAINER ID   IMAGE           COMMAND      CREATED          STATUS                     PORTS     NAMES
0538560b9cc1  centos:latest   "sleep30"   33 seconds ago   Exited (0) 3 seconds ago             os1
```

## 容器启动/关闭/重启

```bash
[root@docker ~]# docker run -tid --name os1 --restart always centos
8e55bf36ce38a95a683599a65166f51725095cfe5536fd02251d7a835a20570a
[root@docker ~]# docker stop os1
os1
[root@docker ~]# docker start os1
os1
[root@docker ~]# docker restart os1
```

## 创建一个 mysql 容器

```bash
[root@docker ~]# docker run -tid --name db1 --restart always mysql:latest
# 会容器发现一直在重启
[root@docker ~]# docker ps
CONTAINER ID   IMAGE          COMMAND                  CREATED              STATUS                         PORTS     NAMES
7ae99a2284bc  mysql:latest  "docker-entrypoint.s…"  About a minute ago   Restarting (1) 6 seconds ago             db1
[root@docker ~]# 
```

不知道原因？查查日志。日志怎么查？

## 查询容器日志 logs

```bash
[root@docker ~]# docker logs db1
2024-03-10 07:31:52+00:00 [Note] [Entrypoint]: Entrypoint script forMySQL Server 8.3.0-1.el8 started.
2024-03-10 07:31:53+00:00 [Note] [Entrypoint]: Switching to dedicateduser 'mysql'
2024-03-10 07:31:53+00:00 [Note] [Entrypoint]: Entrypoint script forMySQL Server 8.3.0-1.el8 started.
2024-03-10 07:31:53+00:00 [ERROR] [Entrypoint]: Database isuninitialized and password option is not specified
    You need to specify one ofthe following as an environment variable:
    - MYSQL_ROOT_PASSWORD
    -MYSQL_ALLOW_EMPTY_PASSWORD
    - MYSQL_RANDOM_ROOT_PASSWORD
[root@docker ~]# 
```

## 指定环境变量 -e

```bash
[root@docker ~]# docker run -tid --name db1 --restart always -e MYSQL_ROOT_PASSWORD=redhat mysql:latest
ed0c6579c24becfaf1a681777fb7becc8a7497791c71e2108ca5fe89e1e56e19
[root@docker ~]# 
带上环境变量正常了
[root@docker ~]# docker exec -ti db1/bin/bash
bash-4.4# mysql -uroot -predhat
mysql: [Warning] Using a password on the command line interface canbe insecure.
Welcome to the MySQL monitor. Commands end with ; or \g.
Your MySQL connection id is 8
Server version: 8.3.0 MySQL Community Server - GPL

Copyright (c) 2000, 2024, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current inputstatement.

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.00 sec)

mysql>
```

一般数据库都是在外面登录的，不是进入到容器之后，在容器里面连接数据库的。

如何在 linux 上连接容器数据库呢？

要连接容器数据库，首先得知道它的 ip 地址。

## 查看容器具体属性 inspect

```bash
[root@docker ~]# docker inspect db1 |grep -i ipaddr            # -i 忽略大小写
           "SecondaryIPAddresses": null,
           "IPAddress": "172.17.0.2",
                    "IPAddress":"172.17.0.2",
[root@docker ~]#

# 查询到容器数据库服务端 ip 地址后，本地安装客户端
yum install -y mariadb
[root@docker ~]# mysql -u root -predhat -h 172.17.0.2            # 这里的 -p 和密码之间不能有空格
Welcome to the MariaDB monitor. Commands end with ; or \g.
Your MySQL connection id is 9
Server version: 8.3.0 MySQL Community Server - GPL

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current inputstatement.

MySQL [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.001 sec)

MySQL [(none)]>
```

假如我要拿三方工具去连接容器呢？这个问题就涉及到容器如何对外暴露的问题了。

## 添加端口映射 -p

```bash
[root@docker ~]# docker pull nginx
[root@docker ~]# docker run -tid --name web1 --restart always -p 5000:80 nginx:latest
```

## 实验：部署 wordpress 博客

一个 mysql，一个 wordpress，需要让 wordpress 连接 mysql，作为博客后端的数据库。

```bash
# 拉取 mysql 和 wordpress 镜像
[root@docker ~]# 
docker pull wordpress
docker pull mysql

# 创建 mysql 容器
# mysql 未来要单独为 wordpress 博客创建一个数据库（wordpress）
[root@docker ~]# docker run -tid --name db --restart always -e MYSQL_ROOT_PASSWORD=redhat -e MYSQL_DATABASE=wordpress mysql:latest
# 创建 wordpress 容器
[root@docker ~]# docker run -tid --name blog --restart always -e WORDPRESS_DB_HOST=172.17.0.2 -e WORDPRESS_DB_USER=root -e WORDPRESS_DB_PASSWORD=redhat -e WORDPRESS_DB_NAME=wordpress -p 8080:80 wordpress:latest
```

需要哪些参数，参考 docker hub 官方文档

https://hub.docker.com/_/wordpress

## 容器与主机之间拷贝

```bash
[root@docker ~]# docker cp /etc/hosts os1:/tmp
Successfully copied 2.048kB to os1:/tmp
[root@docker ~]# docker exec -ti 
db   os1  web  
[root@docker ~]# docker exec -ti os1 ls /tmp
hosts
[root@docker ~]# docker exec -ti os1 /bin/sh
/ # ls /tmp/
hosts
/ # exit
[root@docker ~]# 
[root@docker ~]# docker exec -ti os1 /bin/sh
/ # cd /tmp/
/tmp # touch hehe.txt
/tmp # ls
hehe.txt  hosts
/tmp # exit
[root@docker ~]# docker cp os1:/tmp/hehe.txt .
Successfully copied 1.536kB to /root/.
[root@docker ~]# ls
anaconda-ks.cfg  hehe.txt
[root@docker ~]# 
```

## 将容器提交成镜像

镜像打包即可

```bash
[root@docker ~]# docker ps
CONTAINER ID   IMAGE           COMMAND       CREATED          STATUS          PORTS     NAMES
21969deaba2e  centos:latest  "/bin/bash"   10 minutesago   Up 10 minutes             os1
[root@docker ~]# docker commit os1 centos:memeda
sha256:ed3d15f729e24e209d34693e921c2925433da31eae6acb2995457d004025026c
[root@docker ~]# docker images
REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
centos       memeda    ed3d15f729e2   3 seconds ago   231MB
[root@docker ~]# 
```

# 容器网络

# 容器存储

# ---