<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }} | {{ site.title }}</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/style.css">

    <script>
    MathJax = {
      tex: { 
          inlineMath: [['$', '$'], ['\\(', '\\)']], 
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true 
      },
      svg: { fontCache: 'global' }
    };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <script>
        if (localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        if (localStorage.getItem('sidebar-status') === 'closed') {
            document.documentElement.classList.add('sidebar-closed-init');
        }
    </script>
    <style>
        html.sidebar-closed-init body { padding-left: 0; }
        html.sidebar-closed-init .sidebar { transform: translateX(-100%); }
    </style>
</head>
<body>

    {% unless page.url == "/" or page.url == "/index.html" %}
    <button id="sidebar-expand-trigger" title="展开目录">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="13 17 18 12 13 7"></polyline>
            <polyline points="6 17 11 12 6 7"></polyline>
        </svg>
    </button>
    {% endunless %}

    <aside class="sidebar">
        {% if page.url == "/" or page.url == "/index.html" %}
            <div id="label-container">
                <a href="#" class="label-item active" data-filter="all">全部文章</a>
                {% assign all_labels = site.posts | map: "blog-label" | compact | uniq %}
                {% for label in all_labels %}
                    <a href="#" class="label-item" data-filter="{{ label }}">{{ label }}</a>
                {% endfor %}
            </div>

        {% else %}
            <div class="sidebar-controls">
                <a href="/" class="back-btn">
                    << 返回首页
                </a>
                
                <button class="sidebar-close-btn" id="sidebar-close-trigger" title="折叠目录">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="11 17 6 12 11 7"></polyline>
                        <polyline points="18 17 13 12 18 7"></polyline>
                    </svg>
                </button>
            </div>

            <div id="toc-container"></div>
        {% endif %}
    </aside>

    <main class="content-area">
        {% if page.url == "/" or page.url == "/index.html" %}
        <header class="site-header">
            <a href="/" class="site-logo">{{ site.title }}</a>
            <nav class="header-nav">
                <a href="/resume.html">About</a>
                <a href="https://github.com/librebitx">GitHub</a>
                <span id="theme-toggle">L/D</span>
            </nav>
        </header>
        {% endif %}

        <div id="main-content">
            {{ content }}
        </div>
    </main>

	<button id="back-to-top" title="回到顶部">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
    </button>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        mermaid.initialize({ 
            startOnLoad: false,
            theme: isDark ? 'dark' : 'neutral',
            securityLevel: 'loose'
        });

        document.addEventListener("DOMContentLoaded", async () => {
            const mermaidBlocks = document.querySelectorAll('pre code.language-mermaid');
            mermaidBlocks.forEach(codeBlock => {
                const graphDefinition = codeBlock.textContent;
                const newDiv = document.createElement('div');
                newDiv.className = 'mermaid';
                newDiv.textContent = graphDefinition;
                const container = codeBlock.closest('.highlighter-rouge') || codeBlock.parentElement;
                container.replaceWith(newDiv);
            });
            await mermaid.run({ querySelector: '.mermaid' });
        });
    </script>

    <script>
        // 侧边栏折叠
        const closeBtn = document.getElementById('sidebar-close-trigger');
        const expandBtn = document.getElementById('sidebar-expand-trigger');
        
        if (localStorage.getItem('sidebar-status') === 'closed') {
            document.body.classList.add('sidebar-closed');
            document.documentElement.classList.remove('sidebar-closed-init');
        }

        function toggleSidebar() {
            document.body.classList.toggle('sidebar-closed');
            const isClosed = document.body.classList.contains('sidebar-closed');
            localStorage.setItem('sidebar-status', isClosed ? 'closed' : 'open');
        }

        if (closeBtn) closeBtn.addEventListener('click', toggleSidebar);
        if (expandBtn) expandBtn.addEventListener('click', toggleSidebar);

        // 标签筛选
        if (document.getElementById('label-container')) {
            document.querySelectorAll('.label-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const filter = item.getAttribute('data-filter');
                    document.querySelectorAll('.label-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                    document.querySelectorAll('.post-item').forEach(post => {
                        if (filter === 'all' || post.getAttribute('data-label') === filter) post.style.display = 'flex';
                        else post.style.display = 'none';
                    });
                });
            });
        }

        // 目录生成 (H1 - H6)
        if (document.getElementById('toc-container')) {
            const container = document.getElementById('toc-container');
            const content = document.getElementById('main-content');
            const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
            
            if (headings.length === 0) {
                container.innerHTML = '<span style="color:var(--gray-mid);font-size:0.85rem;">本文无目录</span>';
            } else {
                headings.forEach((h, i) => {
                    const id = h.id || `heading-${i}`;
                    h.id = id;
                    const a = document.createElement('a');
                    a.href = `#${id}`;
                    a.innerText = h.innerText;
                    a.className = `toc-link toc-${h.tagName.toLowerCase()}`;
                    container.appendChild(a);
                });
            }
        }

        // 深色模式
        const themeBtn = document.getElementById('theme-toggle');
        if (themeBtn) {
            themeBtn.addEventListener('click', () => {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const next = isDark ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
            });
        }
        
        // 回到顶部
        const backToTopBtn = document.getElementById('back-to-top');
        
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                backToTopBtn.classList.add('visible');
            } else {
                backToTopBtn.classList.remove('visible');
            }
        });

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
        
    </script>
</body>
</html>
